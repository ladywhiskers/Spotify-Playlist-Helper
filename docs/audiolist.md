# Audiolist

Начиная с версии `2.1` goofy умеет принимать запросы от [андроид приложения Audiolist](https://play.google.com/store/apps/details?id=ru.chimildic.audiolist) и возвращать ответ при необходимости.

## Настройка

### goofy

1. Обновите goofy до последней версии ([файл library](https://github.com/Chimildic/goofy/blob/main/library.js)). Для перехода с версии `1.x` на `2.x` воспользуйтесь [миграцией](/migrate2).
2. В редакторе кода нажмите _начать развертывание_ > _новое развертывание_. Убедитесь, что выбрана конфигурация с веб-приложением и доступом для всех. Нажмите _начать развертывание_.

   ![Новое развертывание](/img/new-deploy-audiolist.png ':size=60%')

3. Скопируйте `идентификатор развертывания` и удобным вам способом перенесите на устройство где установлен Audiolist.

   !> Не передавайте идентификатор другим пользователям. Они смогут запускать ваши функции.

### Audiolist

1. Создайте программу в Audiolist и добавьте из общего списка команду `функция goofy`. 
2. При заполнении формы команды оставьте поля с переменными пустыми. Укажите `идентификатор развертывания`, полученный при настройке goofy. В качестве _имени функции_ для примера используем `Audiolist.hello`

  ![Команда "Функция goofy"](/img/goofy-command-audiolist.jpg ':size=60%')

3. Выйдите из редактора программы и запустите выполнение программы. Если все сделано верно, в логах появится сообщение от goofy.

## Использование

Чтобы все прошло гладко важно три вещи:

1. Правильное имя функции в настройках команды. Регистр букв имеет значение.
2. Возврат результата. Audiolist использует типизированный язык программирования и ожидает относительно строгий формат ответа.
3. Обновление развертывания при любом изменении кода goofy. Развертывание - это изолированная копия. Если добавить/изменить функцию и не обновить развертывание, Audiolist не сможет достучаться до неё.

### Пустой ответ

```js
function doSomething() {
    // Алгоритм вашей функции
    // ...

    // Возврат результата
    return Audiolist.response()
}
```

### Возврат текста

Помимо текста можно указать тип: обычное, предупреждение, ошибка. От типа зависит цвет сообщения в логах. Прерывания программы не будет.

```js
function doSomethingMessage() {
    // Алгоритм вашей функции
    // ...

    let text = "Этот текст появится в логах Audiolist"
    return Audiolist.responseMessage(text, Audiolist.MESSAGE_TYPES.WARNINNG)
}
```

### Возврат треков

Чтобы Audiolist смог преобразовать массив элементов от goofy в понятный для себя формат, необходимо указать один из типов `Audiolist.VARIABLE_TYPES`. Пример кода ниже возвращает 20 любимых Spotify треков. Однако на практике в такой функции нет смысла. Audiolist имеет свои команды для сбора треков. Проще получить те же любимые треки не прибегая к goofy. Но будет полезно для импорта других источников (кэш, радио и прочее).

```js
function doSomethingItems() {
    let tracks = Source.getSavedTracks(20)
    // ...

    return Audiolist.responseItems(tracks, Audiolist.VARIABLE_TYPES.SPOTIFY_TRACK)
}
```

### Комплексный пример

Если указать источник данных для команды "Функция goofy", Audiolist отправит его в указанную функцию. При этом одновременно можно ответить текстом и треками.

```js
function complexExample(data) {
    let tracksFromAudiolist = data.items
    // ...

    let tracks = // ...

    return Audiolist.response({
        message: 'Сообщение для логов',
        messageType: Audiolist.MESSAGE_TYPES.DEFAULT,
        variableType: Audiolist.VARIABLE_TYPES.SPOTIFY_TRACK,
        items: tracks,
    })
}
```

## Обновление развертывания

Нажмите _начать развертывание_ > _управление развертываниями_. В левом списке выберите Audiolist, нажмите кнопку редактирования. Выберите _новую версию_ в списке и нажмите _начать развертывание_.

Иногда Apps Script сбрасывает названия развертываний (похоже на баг). Вам нужно обновлять то развертывание, идентификатор которого указан в команде "Функция goofy".

   ![Новое развертывание](/img/update-deploy-audiolist.png ':size=60%')

### Архив развертываний

Старые версии развертываний попадают в архив. Apps Script устанавливает лимит на количество развертываний (~200). Если вам укажут на лимит или просто накопилось много ненужных версий, в левом меню Apps Script выберите _история версий_. Справа появится список _история проекта_. Внизу списка есть кнопка _массового удаления версий_. Актуальную версию не удалит.
